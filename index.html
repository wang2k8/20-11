<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Parallax - Nghiêng sẵn 15°</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{
            height:100%;
            overflow:hidden;
            background:#fff;
            touch-action:pan-y;
        }
        .scene{
            position:fixed;
            inset:0;
            perspective:1200px;
        }
        .container{
            position:absolute;
            top:50%;left:50%;
            transform:translate(-50%,-50%);
            width:100vmin;
            height:100vmin;
            max-width:100vw;
            max-height:100vh;
        }
        .container::before{
            content:"";
            position:absolute;
            inset:0;
            background:rgba(255,255,255,0.97);
            pointer-events:none;
        }
        img{
            position:absolute;
            top:50%;left:50%;
            transform:translate(-50%,-50%);
            max-width:100%;
            max-height:100%;
            object-fit:contain;
            pointer-events:none;
            user-select:none;
            -webkit-user-drag:none;
            opacity:0;
            transition:opacity .6s ease-out;
        }
        img.loaded{opacity:1}
        #img1{z-index:5}#img2{z-index:4}#img3{z-index:3}#img4{z-index:2}#img5{z-index:1}

        #start{
            position:fixed;
            inset:0;
            background:linear-gradient(135deg,#ff6b6b,#feca57);
            color:#fff;
            font-family:-apple-system,system-ui,sans-serif;
            font-weight:700;
            border:none;
            z-index:9999;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:24px;
        }
        #start.hide{display:none}
        .icon{
            font-size:72px;
            animation:tilt 4s infinite ease-in-out;
        }
        @keyframes tilt{
            0%,100%{transform:rotate(0deg)}
            25%{transform:rotate(15deg)}
            75%{transform:rotate(-10deg)}
        }

        @media(orientation:portrait) and (max-width:768px){
            img{transform:translate(-50%,-50%) rotate(90deg)}
        }
    </style>
</head>
<body>
    <div class="scene">
        <div class="container">
            <img id="img5" src="img1.webp" onerror="this.src='img1.png'" alt="1">
            <img id="img4" src="img2.webp" onerror="this.src='img2.png'" alt="2">
            <img id="img3" src="img3.webp" onerror="this.src='img3.png'" alt="3">
            <img id="img2" src="img4.webp" onerror="this.src='img4.png'" alt="4">
            <img id="img1" src="img5.webp" onerror="this.src='img5.png'" alt="5">
        </div>
    </div>

    <button id="start">
        <div class="icon">3D Parallax</div>
        <div style="font-size:24px">Touch để bật</div>
        <div style="font-size:16px;opacity:0.9">Đã nghiêng sẵn 15° đẹp lung linh</div>
    </button>

    <script>
        const layers = [
            {el:document.getElementById('img1'),f:0.10},
            {el:document.getElementById('img2'),f:0.30},
            {el:document.getElementById('img3'),f:0.60},
            {el:document.getElementById('img4'),f:0.80},
            {el:document.getElementById('img5'),f:1.00}
        ];
        const maxMove = 100;
        
        // MẶC ĐỊNH NGHIÊNG 15° SANG PHẢI + 8° LÊN TRÊN → ĐẸP NHẤT
        const DEFAULT_X = 15;
        const DEFAULT_Y = -8;

        const btn = document.getElementById('start');
        let granted = false;

        // NGHIÊNG SẴN 15° NGAY TỪ GIÂY ĐẦU TIÊN
        move(DEFAULT_X, DEFAULT_Y);

        // Preload WebP siêu nhanh
        ['img1.webp','img2.webp','img3.webp','img4.webp','img5.webp'].forEach(src=>{
            const img = new Image();
            img.src = src;
            img.decoding = 'async';
            img.onload = () => {
                const el = document.querySelector(`[src="${src}"]`);
                if(el) el.classList.add('loaded');
            };
        });

        btn.onclick = () => {
            if(typeof DeviceOrientationEvent?.requestPermission === 'function'){
                DeviceOrientationEvent.requestPermission().then(r=>{
                    if(r==='granted'){
                        granted = true;
                        btn.classList.add('hide');
                        startSensors();
                    }
                });
            }else{
                granted = true;
                btn.classList.add('hide');
                startSensors();
            }
        };

        function startSensors(){
            window.addEventListener('deviceorientation', e=>{
                if(!granted) return;
                const x = e.gamma || 0;
                const y = e.beta  || 0;
                move(x, y);
            });

            // PC vẫn dùng chuột
            document.addEventListener('mousemove', e=>{
                const mx = (e.clientX/innerWidth - 0.5)*50;
                const my = (e.clientY/innerHeight - 0.5)*50;
                move(mx, my);
            });
        }

        function move(dx, dy){
            requestAnimationFrame(()=>{
                layers.forEach(l=>{
                    const ex = Math.tanh(dx * l.f / maxMove) * maxMove;
                    const ey = Math.tanh(dy * l.f / maxMove) * maxMove;
                    const rot = dx * 0.05;
                    l.el.style.transform = 
                        `translate(-50%,-50%) translate(${ex}px,${ey}px) rotate(${rot}deg)`;
                });
            });
        }

        // Tự chạy nếu không phải iOS
        if(!/iPad|iPhone|iPod/.test(navigator.userAgent)){
            granted = true;
            btn.classList.add('hide');
            startSensors();
        }
    </script>
</body>
</html>
