<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10">
    <title>Khoảnh Khắc Bên Thầy Cô - 12a1</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{
            height:100%;
            overflow:hidden;
            background:#fff;
            touch-action:none; /* quan trọng để pinch mượt */
        }
        .scene{
            position:fixed;
            inset:0;
            perspective:1200px;
            overflow:hidden;
        }
        .container{
            position:absolute;
            top:50%;left:50%;
            transform:translate(-50%,-50%);
            width:100vmin;
            height:100vmin;
            max-width:100vw;
            max-height:100vh;
            transform-origin:center center;
            transition:transform .3s ease-out;
        }
        .container::before{
            content:"";
            position:absolute;
            inset:0;
            background:rgba(255,255,255,0.97);
            pointer-events:none;
        }
        img{
            position:absolute;
            top:50%;left:50%;
            transform:translate(-50%,-50%);
            max-width:100%;
            max-height:100%;
            object-fit:contain;
            pointer-events:none;
            user-select:none;
            -webkit-user-drag:none;
            opacity:0;
            transition:opacity .6s ease-out;
        }
        img.loaded{opacity:1}
        #img1{z-index:5}#img2{z-index:4}#img3{z-index:3}#img4{z-index:2}#img5{z-index:1}

        #start{
            position:fixed;
            inset:0;
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:#fff;
            font-family:-apple-system,system-ui,sans-serif;
            font-weight:700;
            border:none;
            z-index:9999;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:24px;
        }
        #start.hide{display:none}
        .icon{font-size:68px;animation:tilt 4s infinite ease-in-out}
        @keyframes tilt{
            0%,100%{transform:rotate(0deg)}
            25%{transform:rotate(15deg)}
            75%{transform:rotate(-10deg)}
        }

        @media(orientation:portrait) and (max-width:768px){
            img{transform:translate(-50%,-50%) rotate(90deg)}
        }
    </style>
</head>
<body>
    <div class="scene" id="scene">
        <div class="container" id="container">
            <img id="img5" src="img1.webp" onerror="this.src='img1.png'" alt="1">
            <img id="img4" src="img2.webp" onerror="this.src='img2.png'" alt="2">
            <img id="img3" src="img3.webp" onerror="this.src='img3.png'" alt="3">
            <img id="img2" src="img4.webp" onerror="this.src='img4.png'" alt="4">
            <img id="img1" src="img5.webp" onerror="this.src='img5.png'" alt="5">
        </div>
    </div>

    <button id="start">
        <div class="icon">3D ZOOM</div>
        <div style="font-size:24px">Touch để bật</div>
        <div style="font-size:16px;opacity:0.9">Pinch để zoom • Double-tap x2</div>
    </button>

    <script>
        const layers = [
            {el:document.getElementById('img1'),f:0.10},
            {el:document.getElementById('img2'),f:0.30},
            {el:document.getElementById('img3'),f:0.60},
            {el:document.getElementById('img4'),f:0.80},
            {el:document.getElementById('img5'),f:1.00}
        ];
        const maxMove = 18;
        const DEFAULT_X = 16;
        const DEFAULT_Y = -12;

        const btn = document.getElementById('start');
        const container = document.getElementById('container');
        const scene = document.getElementById('scene');
        let granted = false;

        // === NGHIÊNG SẴN 15° ===
        move(DEFAULT_X, DEFAULT_Y);

        // === PRELOAD WEBP ===
        ['img1.webp','img2.webp','img3.webp','img4.webp','img5.webp'].forEach(src=>{
            const img = new Image();
            img.src = src;
            img.decoding = 'async';
            img.onload = () => document.querySelector(`[src="${src}"]`)?.classList.add('loaded');
        });

        // === XIN QUYỀN & BẬT ===
        btn.onclick = () => {
            if(typeof DeviceOrientationEvent?.requestPermission === 'function'){
                DeviceOrientationEvent.requestPermission().then(r=>{
                    if(r==='granted'){
                        granted = true;
                        btn.classList.add('hide');
                        startAll();
                    }
                });
            }else{
                granted = true;
                btn.classList.add('hide');
                startAll();
            }
        };

        function startAll(){
            // Gyro
            window.addEventListener('deviceorientation', e=>{
                if(!granted) return;
                move(e.gamma||0, e.beta||0);
            });

            // PC chuột
            document.addEventListener('mousemove', e=>{
                const mx = (e.clientX/innerWidth - 0.5)*50;
                const my = (e.clientY/innerHeight - 0.5)*50;
                move(mx, my);
            });

            // === ZOOM + PAN (dùng Hammer.js thuần JS, không cần thư viện) ===
            let scale = 1;
            let posX = 0, posY = 0;
            let startX, startY, startScale;

            scene.addEventListener('wheel', e=>{
                e.preventDefault();
                scale = Math.max(0.5, Math.min(6, scale - e.deltaY*0.005));
                updateTransform();
            });

            scene.addEventListener('gesturestart', e=>e.preventDefault());
            scene.addEventListener('gesturechange', e=>e.preventDefault());

            let lastTap = 0;
            scene.addEventListener('touchstart', e=>{
                if(e.touches.length === 2){
                    e.preventDefault();
                    startScale = scale;
                    const t1 = e.touches[0], t2 = e.touches[1];
                    startX = (t1.clientX + t2.clientX)/2;
                    startY = (t1.clientY + t2.clientY)/2;
                }
                // Double-tap zoom x2
                const now = Date.now();
                if(now - lastTap < 300){
                    scale = scale < 1.5 ? 2.5 : 1;
                    posX = posY = 0;
                    updateTransform();
                }
                lastTap = now;
            });

            scene.addEventListener('touchmove', e=>{
                if(e.touches.length === 2){
                    e.preventDefault();
                    const t1 = e.touches[0], t2 = e.touches[1];
                    const currentDist = Math.hypot(t1.clientX-t2.clientX, t1.clientY-t2.clientY);
                    const startDist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX + startX*2 - startX*2,
                        e.touches[0].clientY - e.touches[1].clientY + startY*2 - startY*2
                    );
                    const newScale = startScale * (currentDist / Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX + 100,
                        e.touches[0].clientY - e.touches[1].clientY + 100
                    ));
                    scale = Math.max(0.5, Math.min(6, newScale || scale));

                    // Pan khi zoom
                    posX = (t1.clientX + t2.clientX)/2 - startX;
                    posY = (t1.clientY + t2.clientY)/2 - startY;

                    updateTransform();
                }
            });

            function updateTransform(){
                container.style.transform = 
                    `translate(-50%,-50%) scale(${scale}) translate(${posX/scale}px,${posY/scale}px)`;
            }
        }

        function move(dx, dy){
            requestAnimationFrame(()=>{
                layers.forEach(l=>{
                    const ex = Math.tanh(dx * l.f / maxMove) * maxMove;
                    const ey = Math.tanh(dy * l.f / maxMove) * maxMove;
                    const rot = dx * 0.05;
                    l.el.style.transform = 
                        `translate(-50%,-50%) translate(${ex}px,${ey}px) rotate(${rot}deg)`;
                });
            });
        }

        // Tự chạy nếu Android/PC
        if(!/iPad|iPhone|iPod/.test(navigator.userAgent)){
            granted = true;
            btn.classList.add('hide');
            startAll();
        }
    </script>
</body>
</html>

