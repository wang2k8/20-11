<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>3D Layer 1n - Nâng cấp</title>
<style>
  * {margin:0;padding:0;box-sizing:border-box;}
  html,body {
    height:100%;
    overflow:hidden;
    background:#000;
    font-family:sans-serif;
    touch-action:pan-x pan-y;
  }

  #wrapper {
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    perspective:1200px;
    width:100vw;height:100vh;
    will-change:transform;
  }

  #container {
    width:100%;height:100%;
    position:relative;
    transform-style:preserve-3d;
  }

  .layer {
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    backface-visibility:hidden;
    transition:opacity .4s ease;
    will-change:transform,opacity;
    opacity:0;
  }

  .layer img {
    width:90vw;max-width:900px;display:block;
    -webkit-user-drag:none;
  }

  .visible {opacity:1;}

  #start-btn {
    position:fixed;top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#00aaff;color:#fff;
    border:none;border-radius:50px;
    padding:16px 32px;font-size:1.2em;
    font-weight:bold;z-index:999;
    box-shadow:0 8px 20px rgba(0,0,0,.5);
    animation:pulse 2s infinite;
    display:none;
  }

  @keyframes pulse {
    0%,100%{transform:translate(-50%,-50%) scale(1);}
    50%{transform:translate(-50%,-50%) scale(1.05);}
  }

  @media(max-width:768px){#start-btn{display:block;}}
  #start-btn.active{display:none;}

  #calibrate-btn {
    position:fixed;
    top:20px;right:20px;
    background:#ffaa00;color:#fff;
    border:none;border-radius:50px;
    padding:12px 24px;font-size:1em;
    font-weight:bold;z-index:999;
    box-shadow:0 4px 10px rgba(0,0,0,.5);
    display:none;
    cursor:pointer;
  }
  #calibrate-btn.show{display:block;}

  #hint {
    position:fixed;
    bottom:20px;left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.6);
    color:#fff;
    padding:8px 16px;
    border-radius:20px;
    font-size:14px;
    opacity:0;
    transition:opacity .3s;
    pointer-events:none;
    z-index:10;
  }
  #hint.show {opacity:1;}
</style>
</head>
<body>

<button id="start-btn">BẮT ĐẦU 3D</button>
<button id="calibrate-btn">Hiệu chuẩn</button>
<div id="hint">Nghiêng điện thoại để xem 3D (Chạm để ẩn)</div>
<div id="wrapper"><div id="container"></div></div>

<script>
const wrapper=document.getElementById('wrapper');
const container=document.getElementById('container');
const startBtn=document.getElementById('start-btn');
const calibrateBtn=document.getElementById('calibrate-btn');
const hint=document.getElementById('hint');

const totalLayers=5;
const layers=[];
const settings=[
  {z:0,scale:1.8,opacity:1,parallax:0.2},
  {z:200,scale:1.5,opacity:1,parallax:0.4},
  {z:335,scale:1.3,opacity:1,parallax:0.6},
  {z:470,scale:1.1,opacity:0.95,parallax:0.8},
  {z:535,scale:1.0,opacity:1,parallax:1}
];

let is3D=false;
let tiltX=0,tiltY=0,tiltZ=0;
let zoom=1;
let scrollY=0;
const MAX_TILT=1.8; // Giữ nguyên mức xoay tối đa
const MAX_TILT_Z=45; // Mức xoay Z tối đa (mới)

let needRender=false; // Cho RAF

function render(){
  if(!is3D)return;
  container.style.transform=`rotateX(${tiltX}deg) rotateY(${tiltY}deg) rotateZ(${tiltZ}deg) scale(${zoom})`;
  layers.forEach((l,i)=>{
    const s=settings[i];
    const offset=scrollY*s.parallax;
    l.style.transform=`translate(-50%,-50%) translateZ(${s.z}px) translateY(${offset}px) scale(${s.scale})`;
  });
  needRender=false;
}

function animate(){
  if(needRender)render();
  requestAnimationFrame(animate);
}
animate(); // Bắt đầu RAF loop

function setupLayers(){
  for(let i=0;i<totalLayers;i++){
    const div=document.createElement('div');
    div.className='layer';
    const img=new Image();
    img.src=`img${i+1}.png`; // Đặt 5 ảnh img1.png → img5.png trong cùng thư mục
    img.onload=()=>div.classList.add('visible');
    div.appendChild(img);
    container.appendChild(div);
    layers.push(div);
  }
  render();
}

setupLayers();

// -------- FULLSCREEN -------------
function goFullscreen(){
  const el=document.documentElement;
  if(el.requestFullscreen)el.requestFullscreen();
  else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
}

// -------- MOBILE / DESKTOP --------
const isMobile=/Mobi|Android|iPhone/i.test(navigator.userAgent);

if(!isMobile){
  is3D=true;
  goFullscreen();
  document.addEventListener('mousemove',e=>{
    const rect=wrapper.getBoundingClientRect();
    const cx=rect.left+rect.width/2;
    const cy=rect.top+rect.height/2;
    tiltY=((e.clientX-cx)/cx)*MAX_TILT;
    tiltX=-((e.clientY-cy)/cy)*MAX_TILT;
    needRender=true; // Trigger render qua RAF
  });
} else {
  startBtn.addEventListener('click',()=>{
    startBtn.classList.add('active');
    calibrateBtn.classList.add('show');
    goFullscreen();
    startSensor();
    hint.classList.add('show');
    setTimeout(()=>hint.classList.remove('show'),5000); // Hiển thị lâu hơn
  });
  calibrateBtn.addEventListener('click',()=>{
    smoothX=0;smoothY=0;smoothZ=0;
    tiltX=0;tiltY=0;tiltZ=0;
    needRender=true;
  });
  hint.addEventListener('click',()=>hint.classList.remove('show')); // Cho phép tắt hint
}

// -------- CẢM BIẾN ỔN ĐỊNH (Nâng cấp) --------
let smoothX=0,smoothY=0,smoothZ=0;
const SMOOTH=0.15; // Tăng smoothing
const DEADZONE=0.1; // Deadzone để tránh jitter

function startSensor(){
  is3D=true;
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission()
      .then(state=>{
        if(state==='granted')window.addEventListener('deviceorientation',handleOri);
        else fallbackTouch();
      }).catch(fallbackTouch);
  } else {
    window.addEventListener('deviceorientation',handleOri);
  }
}

function handleOri(e){
  if(!is3D)return;
  let gx=e.gamma||0, gy=e.beta||0, gz=e.alpha||0;
  // Áp dụng deadzone
  if(Math.abs(gx)<DEADZONE)gx=0;
  if(Math.abs(gy)<DEADZONE)gy=0;
  if(Math.abs(gz)<DEADZONE)gz=0;
  // Smoothing
  smoothX+=(gx-smoothX)*SMOOTH;
  smoothY+=(gy-smoothY)*SMOOTH;
  smoothZ+=(gz-smoothZ)*SMOOTH;
  // Giới hạn
  tiltY=Math.max(-MAX_TILT,Math.min(MAX_TILT,smoothX));
  tiltX=Math.max(-MAX_TILT,Math.min(MAX_TILT, smoothY-45));
  tiltZ=Math.max(-MAX_TILT_Z,Math.min(MAX_TILT_Z,smoothZ));
  needRender=true; // Trigger render qua RAF
}

// -------- Fallback TOUCH (Nâng cấp) --------
function fallbackTouch(){
  let sx=0,sy=0, smoothTouchX=0, smoothTouchY=0;
  container.addEventListener('touchstart',e=>{
    if(e.touches.length===1){
      sx=e.touches[0].clientX;
      sy=e.touches[0].clientY;
    }
  },{passive:true});
  container.addEventListener('touchmove',e=>{
    if(e.touches.length!==1)return;
    const dx=(e.touches[0].clientX-sx)/innerWidth;
    const dy=(e.touches[0].clientY-sy)/innerHeight;
    // Smoothing cho touch
    smoothTouchX+=(dx-smoothTouchX)*SMOOTH;
    smoothTouchY+=(dy-smoothTouchY)*SMOOTH;
    tiltY=smoothTouchX*MAX_TILT*2;
    tiltX=-smoothTouchY*MAX_TILT*2;
    needRender=true;
  },{passive:true});
}

// -------- ZOOM / SCROLL --------
document.addEventListener('wheel',e=>{
  if(!is3D)return;
  scrollY=Math.max(-30,Math.min(30,scrollY+e.deltaY*0.05));
  needRender=true;
},{passive:true});

let pinch=0;
container.addEventListener('touchmove',e=>{
  if(e.touches.length===2){
    const d=Math.hypot(
      e.touches[0].pageX-e.touches[1].pageX,
      e.touches[0].pageY-e.touches[1].pageY);
    if(!pinch)pinch=d;
    zoom=Math.max(0.6,Math.min(2.5,zoom*(d/pinch)));
    pinch=d;
    needRender=true;
  }
},{passive:true});
container.addEventListener('touchend',()=>pinch=0);

// -------- XOAY NGANG/DỌC ỔN --------
function adjustRotate(){
  if(!isMobile)return;
  const land=innerWidth>innerHeight;
  wrapper.style.transform=`translate(-50%,-50%) rotate(${land?0:90}deg)`;
}
window.addEventListener('orientationchange',()=>setTimeout(adjustRotate,400));
adjustRotate();

</script>
</body>
</html>
