<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>3D Layer 1n</title>
<style>
  * {margin:0;padding:0;box-sizing:border-box;}
  html,body {
    height:100%;
    overflow:hidden;
    background:#000;
    font-family:sans-serif;
    touch-action:pan-x pan-y;
  }

  #wrapper {
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    perspective:1200px;
    width:100vw;height:100vh;
    will-change:transform;
  }

  #container {
    width:100%;height:100%;
    position:relative;
    transform-style:preserve-3d;
  }

  .layer {
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    backface-visibility:hidden;
    transition:opacity .4s ease;
    will-change:transform,opacity;
    opacity:0;
  }

  .layer img {
    width:90vw;max-width:900px;display:block;
    -webkit-user-drag:none;
  }

  .visible {opacity:1;}

  #start-btn {
    position:fixed;top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#00aaff;color:#fff;
    border:none;border-radius:50px;
    padding:16px 32px;font-size:1.2em;
    font-weight:bold;z-index:999;
    box-shadow:0 8px 20px rgba(0,0,0,.5);
    animation:pulse 2s infinite;
    display:none;
  }

  @keyframes pulse {
    0%,100%{transform:translate(-50%,-50%) scale(1);}
    50%{transform:translate(-50%,-50%) scale(1.05);}
  }

  @media(max-width:768px){#start-btn{display:block;}}
  #start-btn.active{display:none;}

  #hint {
    position:fixed;
    bottom:20px;left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.6);
    color:#fff;
    padding:8px 16px;
    border-radius:20px;
    font-size:14px;
    opacity:0;
    transition:opacity .3s;
    pointer-events:none;
    z-index:10;
  }
  #hint.show {opacity:1;}
</style>
</head>
<body>

<button id="start-btn">B·∫ÆT ƒê·∫¶U 3D</button>
<div id="hint">Nghi√™ng ƒëi·ªán tho·∫°i ƒë·ªÉ xem 3D</div>
<div id="wrapper"><div id="container"></div></div>

<script>
const wrapper=document.getElementById('wrapper');
const container=document.getElementById('container');
const startBtn=document.getElementById('start-btn');
const hint=document.getElementById('hint');

const totalLayers=5;
const layers=[];
const settings=[
  {z:0,scale:1.8,opacity:1,parallax:0.2},
  {z:200,scale:1.5,opacity:1,parallax:0.4},
  {z:335,scale:1.3,opacity:1,parallax:0.6},
  {z:470,scale:1.1,opacity:0.95,parallax:0.8},
  {z:535,scale:1.0,opacity:1,parallax:1}
];

let is3D=false;
let tiltX=0,tiltY=0;
let zoom=1;
let scrollY=0;
const MAX_TILT=7; // üëà Gi·∫£m m·ª©c xoay t·ªëi ƒëa 3 l·∫ßn so v·ªõi tr∆∞·ªõc (20 ‚Üí 7)

function render(){
  if(!is3D)return;
  container.style.transform=`rotateX(${tiltX}deg) rotateY(${tiltY}deg) scale(${zoom})`;
  layers.forEach((l,i)=>{
    const s=settings[i];
    const offset=scrollY*s.parallax;
    l.style.transform=`translate(-50%,-50%) translateZ(${s.z}px) translateY(${offset}px) scale(${s.scale})`;
  });
}

function setupLayers(){
  for(let i=0;i<totalLayers;i++){
    const div=document.createElement('div');
    div.className='layer';
    const img=new Image();
    img.src=`img${i+1}.png`; // ‚ö†Ô∏è ƒê·∫∑t 5 ·∫£nh img1.png ‚Üí img5.png trong c√πng th∆∞ m·ª•c
    img.onload=()=>div.classList.add('visible');
    div.appendChild(img);
    container.appendChild(div);
    layers.push(div);
  }
  render();
}

setupLayers();

// -------- FULLSCREEN -------------
function goFullscreen(){
  const el=document.documentElement;
  if(el.requestFullscreen)el.requestFullscreen();
  else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
}

// -------- MOBILE / DESKTOP --------
const isMobile=/Mobi|Android|iPhone/i.test(navigator.userAgent);

if(!isMobile){
  is3D=true;
  goFullscreen();
  document.addEventListener('mousemove',e=>{
    const rect=wrapper.getBoundingClientRect();
    const cx=rect.left+rect.width/2;
    const cy=rect.top+rect.height/2;
    tiltY=((e.clientX-cx)/cx)*MAX_TILT;
    tiltX=-((e.clientY-cy)/cy)*MAX_TILT;
    render();
  });
} else {
  startBtn.addEventListener('click',()=>{
    startBtn.classList.add('active');
    goFullscreen();
    startSensor();
    hint.classList.add('show');
    setTimeout(()=>hint.classList.remove('show'),3000);
  });
}

// -------- C·∫¢M BI·∫æN ·ªîN ƒê·ªäNH & XOAY NGANG --------
let smoothX = 0, smoothY = 0;
const SMOOTH = 0.08; // m∆∞·ª£t h∆°n (0.12 ‚Üí 0.08)
let orientation = window.orientation || 0; // l∆∞u h∆∞·ªõng xoay hi·ªán t·∫°i

function startSensor() {
  is3D = true;
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(state => {
        if (state === 'granted') {
          window.addEventListener('deviceorientation', handleOri);
          window.addEventListener('orientationchange', () => {
            orientation = window.orientation || 0;
          });
        } else fallbackTouch();
      })
      .catch(fallbackTouch);
  } else {
    window.addEventListener('deviceorientation', handleOri);
    window.addEventListener('orientationchange', () => {
      orientation = window.orientation || 0;
    });
  }
}

function handleOri(e) {
  if (!is3D) return;

  let gx = e.gamma || 0; // nghi√™ng tr√°i/ph·∫£i
  let gy = e.beta || 0;  // nghi√™ng tr∆∞·ªõc/sau

  // L·∫•y g√≥c xoay m√†n h√¨nh (tr√™n iOS c√≥ th·ªÉ l√† undefined)
  let angle = 0;
  if (screen.orientation && typeof screen.orientation.angle === 'number') {
    angle = screen.orientation.angle;
  } else if (typeof window.orientation === 'number') {
    angle = window.orientation;
  }

  // Chu·∫©n h√≥a gi√° tr·ªã g√≥c (ƒë·ªÅ ph√≤ng thi·∫øt b·ªã tr·∫£ -90)
  if (angle === -90) angle = 270;

  // Hi·ªáu ch·ªânh theo h∆∞·ªõng xoay
  let tx = gx, ty = gy;
  switch (angle) {
    case 0: // d·ªçc
      tx = gx;
      ty = gy;
      break;
    case 90: // xoay ngang tr√°i
      tx = gy;
      ty = -gx;
      break;
    case 180: // l·∫≠t ng∆∞·ª£c
      tx = -gx;
      ty = -gy;
      break;
    case 270: // xoay ngang ph·∫£i
      tx = -gy;
      ty = gx;
      break;
  }

  // L·ªçc m∆∞·ª£t
  smoothX += (tx - smoothX) * SMOOTH;
  smoothY += (ty - smoothY) * SMOOTH;

  // Gi·ªõi h·∫°n v√† b√π g√≥c
  tiltY = Math.max(-MAX_TILT, Math.min(MAX_TILT, smoothX));
  tiltX = Math.max(-MAX_TILT, Math.min(MAX_TILT, smoothY - 40)); // gi·∫£m b√π g√≥c d·ªçc

  needRender = true;
}

// -------- Fallback TOUCH --------
function fallbackTouch() {
  let sx = 0, sy = 0;
  container.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      sx = e.touches[0].clientX;
      sy = e.touches[0].clientY;
    }
  }, { passive: true });

  container.addEventListener('touchmove', e => {
    if (e.touches.length !== 1) return;
    const dx = (e.touches[0].clientX - sx) / innerWidth;
    const dy = (e.touches[0].clientY - sy) / innerHeight;
    tiltY = dx * MAX_TILT * 2;
    tiltX = -dy * MAX_TILT * 2;
    render();
  }, { passive: true });
}

// -------- ZOOM / SCROLL --------
document.addEventListener('wheel', e => {
  if (!is3D) return;
  scrollY = Math.max(-30, Math.min(30, scrollY + e.deltaY * 0.05));
  render();
}, { passive: true });

let pinch = 0;
container.addEventListener('touchmove', e => {
  if (e.touches.length === 2) {
    const d = Math.hypot(
      e.touches[0].pageX - e.touches[1].pageX,
      e.touches[0].pageY - e.touches[1].pageY
    );
    if (!pinch) pinch = d;
    zoom = Math.max(0.6, Math.min(2.5, zoom * (d / pinch)));
    pinch = d;
    render();
  }
}, { passive: true });
container.addEventListener('touchend', () => pinch = 0);

// -------- XOAY NGANG/D·ªåC ·ªîN --------
function adjustRotate() {
  if (!isMobile) return;
  const land = innerWidth > innerHeight;
  // Kh√¥ng √©p xoay c·ª©ng, ch·ªâ gi·ªØ khung trung t√¢m
  wrapper.style.transform = `translate(-50%,-50%) ${land ? '' : 'rotate(90deg)'}`;
}
window.addEventListener('orientationchange', () => setTimeout(adjustRotate, 400));
adjustRotate();

</script>
</body>
</html>
