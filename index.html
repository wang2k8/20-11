<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>3D Parallax - Mobile Optimized + Rotate Button</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body, html { height:100%; overflow:hidden; background:#000; font-family:sans-serif; touch-action: pan-x pan-y; }
    
    #container-wrapper {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%) translateZ(0);
      width: 100vw; height: 100vh;
      perspective: 1200px;
      will-change: transform;
    }

    #container {
      width: 100%; height: 100%;
      transform-style: preserve-3d;
      position: relative;
      will-change: transform;
    }

    .layer {
      position: absolute;
      top: 50%; left: 50%;
      width: 90vw; max-width: 900px;
      transform: translate(-50%, -50%) translateZ(0) scale(1);
      opacity: 0;
      will-change: transform;
      backface-visibility: hidden;
      transition: opacity 0.5s ease;
      image-rendering: -webkit-optimize-contrast;
    }
    .layer img {
      width: 100%; height: auto; display: block;
      -webkit-user-drag: none;
      border-radius: 0 !important;
      transform: translateZ(0);
    }
    .layer.visible { opacity: 1; }

    #start-btn {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #00aaff; color: white; border: none; border-radius: 50px;
      padding: 18px 36px; font-size: 1.2em; font-weight: bold; z-index: 9999;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5); cursor: pointer;
      animation: pulse 2s infinite; display: none;
    }
    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
    }
    @media (max-width: 768px) { #start-btn { display: block; } }
    #start-btn.active { display: none; }

    #hint {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.6); color: #fff; padding: 8px 16px; border-radius: 20px;
      font-size: 14px; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 100;
    }
    #hint.show { opacity: 1; }

    /* NÚT XOAY NGANG - GÓC PHẢI DƯỚI */
    #rotate-btn {
      position: fixed;
      bottom: 20px; right: 20px;
      width: 44px; height: 44px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s, transform 0.2s;
      pointer-events: none;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    #rotate-btn.active {
      opacity: 1;
      pointer-events: auto;
    }
    #rotate-btn:active {
      transform: scale(0.9);
    }
    @media (min-width: 769px) { #rotate-btn { display: none; } } /* Ẩn trên PC */
  </style>
</head>
<body>

  <button id="start-btn">BẮT ĐẦU 3D</button>
  <div id="hint">Kéo / Nghiêng để xem</div>

  <!-- NÚT XOAY NGANG -->
  <button id="rotate-btn" title="Xoay ngang">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 16v-2a4 4 0 0 0-4-4h-2m-5-4H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6"/>
      <path d="M17 8h4v4"/>
    </svg>
  </button>

  <div id="container-wrapper">
    <div id="container"></div>
  </div>

  <script>
    // === CẤU HÌNH ===
    const container = document.getElementById('container');
    const wrapper = document.getElementById('container-wrapper');
    const startBtn = document.getElementById('start-btn');
    const hint = document.getElementById('hint');
    const rotateBtn = document.getElementById('rotate-btn');
    const layers = [];
    const totalLayers = 5;

    const layerSettings = [
      { z: 0,   scale: 1.8, opacity: 1.0, parallax: 0.2 },
      { z: 200, scale: 1.5, opacity: 1.0, parallax: 0.4 },
      { z: 335, scale: 1.3, opacity: 1.0, parallax: 0.6 },
      { z: 470, scale: 1.1, opacity: 0.95, parallax: 0.8 },
      { z: 535, scale: 1.0, opacity: 1.0, parallax: 1.0 }
    ];

    const MAX_TILT = 1.53125;
    let currentZoom = 1;
    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 3.0;
    let is3DEnabled = false;
    let lastBeta = 0, lastGamma = 0;
    let scrollY = 0;
    let isForcedLandscape = false;

    // === RENDER GỘP ===
    let rafId = null;
    let needsRender = false;
    let lastRotX = 0, lastRotY = 0, lastZoom = 1, lastScrollY = 0;

    function render() {
      if (!is3DEnabled || !needsRender) return;
      needsRender = false;

      container.style.transform = `rotateX(${lastRotX}deg) rotateY(${lastRotY}deg) scale(${lastZoom})`;
      layers.forEach((layer, i) => {
        const s = layerSettings[i];
        const offset = lastScrollY * s.parallax;
        layer.el.style.transform =
          `translate(-50%, -50%) translateZ(${s.z}px) translateY(${offset}px) scale(${s.scale})`;
      });
    }

    function scheduleRender(rotX, rotY, zoom, parallaxY) {
      if (!is3DEnabled) return;
      lastRotX = rotX; lastRotY = rotY; lastZoom = zoom; lastScrollY = parallaxY;
      if (!needsRender) {
        needsRender = true;
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(render);
      }
    }

    // === TẠO LAYER ===
    for (let i = 0; i < totalLayers; i++) {
      const div = document.createElement('div');
      div.className = 'layer';
      const img = new Image();
      img.src = `img${i+1}.png`;
      img.loading = 'eager';
      img.decoding = 'async';
      img.draggable = false;
      div.appendChild(img);
      container.appendChild(div);

      const s = layerSettings[i];
      div.style.opacity = 0;
      layers.push({ el: div, ...s });

      img.onload = () => setTimeout(() => scheduleRender(0, 0, currentZoom, scrollY), 50);
    }

    setTimeout(() => {
      layers.forEach((l, i) => {
        setTimeout(() => {
          l.el.classList.add('visible');
          l.el.style.opacity = l.opacity;
        }, i * 30);
      });
    }, 100);

    // === FULLSCREEN ===
    function goFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    }

    const isDesktop = !/Mobi|Android|iPhone/i.test(navigator.userAgent);

    if (isDesktop) {
      setTimeout(goFullscreen, 300);
      is3DEnabled = true;
      scheduleRender(0, 0, currentZoom, scrollY);
    } else {
      startBtn.addEventListener('click', () => {
        startBtn.classList.add('active');
        is3DEnabled = true;
        goFullscreen();

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') startSensor();
          });
        } else {
          startSensor();
        }

        hint.classList.add('show');
        setTimeout(() => hint.classList.remove('show'), 2500);

        // HIỂN THỊ NÚT XOAY SAU KHI BẮT ĐẦU
        rotateBtn.classList.add('active');
      });
    }

    // === CẢM BIẾN ===
    let sensorActive = false;
    function startSensor() {
      if (sensorActive) return;
      sensorActive = true;

      let lastTime = 0;
      window.addEventListener('deviceorientation', e => {
        if (!is3DEnabled) return;
        const now = performance.now();
        if (now - lastTime < 16) return;
        lastTime = now;

        const gamma = e.gamma ?? lastGamma;
        const beta = e.beta ?? lastBeta;
        lastGamma = gamma; lastBeta = beta;

        const tiltX = Math.max(-MAX_TILT, Math.min(MAX_TILT, gamma));
        const tiltY = Math.max(-MAX_TILT, Math.min(MAX_TILT, beta - 45));
        scheduleRender(-tiltY, tiltX, currentZoom, scrollY);
      });
    }

    // === SCROLL & TOUCH ===
    let touchY = 0, isScrolling = false;
    function handleScroll(delta) {
      scrollY = Math.max(-25, Math.min(25, scrollY + delta));
      scheduleRender(-lastBeta + 45, lastGamma, currentZoom, scrollY);
    }

    document.addEventListener('wheel', e => {
      if (!is3DEnabled) return;
      requestAnimationFrame(() => handleScroll(e.deltaY * 0.08));
    }, { passive: true });

    container.addEventListener('touchstart', e => {
      if (!is3DEnabled) return;
      touchY = e.touches[0].clientY;
      isScrolling = true;
    }, { passive: true });

    container.addEventListener('touchmove', e => {
      if (!is3DEnabled || !isScrolling) return;
      const delta = (touchY - e.touches[0].clientY) * 0.6;
      touchY = e.touches[0].clientY;
      handleScroll(delta);
    }, { passive: true });

    container.addEventListener('touchend', () => { isScrolling = false; });

    // === ZOOM ===
    let pinchStart = 0;
    container.addEventListener('touchstart', e => {
      if (e.touches.length !== 2) return;
      pinchStart = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
    }, { passive: true });

    container.addEventListener('touchmove', e => {
      if (e.touches.length !== 2) return;
      const dist = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
      const delta = dist / pinchStart;
      currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom * delta));
      pinchStart = dist;
      scheduleRender(-lastBeta + 45, lastGamma, currentZoom, scrollY);
    }, { passive: true });

    // === NÚT XOAY NGANG ===
    rotateBtn.addEventListener('click', async () => {
      if (!screen.orientation) return;

      try {
        if (!isForcedLandscape) {
          await screen.orientation.lock('landscape');
          isForcedLandscape = true;
          rotateBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16v-2a4 4 0 0 0-4-4h-2m-5-4H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6"/>
            </svg>
          `;
          rotateBtn.title = "Đang ở chế độ ngang";
        } else {
          screen.orientation.unlock();
          isForcedLandscape = false;
          rotateBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16v-2a4 4 0 0 0-4-4h-2m-5-4H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6"/>
              <path d="M17 8h4v4"/>
            </svg>
          `;
          rotateBtn.title = "Xoay ngang";
        }
      } catch (err) {
        alert("Không thể khóa hướng màn hình. Vui lòng xoay thiết bị.");
      }
    });

    // === CẬP NHẬT TRẠNG THÁI NÚT KHI XOAY ===
    function updateRotateButton() {
      if (!is3DEnabled || isDesktop) return;

      const isLandscape = window.innerWidth > window.innerHeight;
      if (isLandscape && !isForcedLandscape) {
        rotateBtn.classList.remove('active');
      } else {
        rotateBtn.classList.add('active');
      }
    }

    // === XOAY MÀN HÌNH ===
    let resizeTimer;
    function updateOrientation() {
      if (isDesktop) return;

      let isLandscape = false;
      if (window.screen?.orientation?.type) {
        isLandscape = ['landscape-primary', 'landscape-secondary'].includes(window.screen.orientation.type);
      } else {
        isLandscape = window.innerWidth > window.innerHeight;
      }

      wrapper.style.width = isLandscape ? '100vw' : '100vh';
      wrapper.style.height = isLandscape ? '100vh' : '100vw';
      wrapper.style.transform = `translate(-50%, -50%) rotate(${isLandscape ? 0 : 90}deg)`;

      updateRotateButton();
    }

    window.addEventListener('orientationchange', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        updateOrientation();
      }, 100);
    });
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(updateOrientation, 100);
    });
    updateOrientation();

    // === DESKTOP MOUSE ===
    if (isDesktop) {
      let mouseRaf = null;
      document.addEventListener('mousemove', e => {
        const rect = wrapper.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const mouseX = ((e.clientX - cx) / cx) * MAX_TILT;
        const mouseY = ((e.clientY - cy) / cy) * MAX_TILT;

        cancelAnimationFrame(mouseRaf);
        mouseRaf = requestAnimationFrame(() => {
          scheduleRender(mouseY, mouseX, currentZoom, scrollY);
        });
      }, { passive: true });

      document.addEventListener('mouseleave', () => scheduleRender(0, 0, currentZoom, scrollY));
    }
  </script>
</body>
</html>
