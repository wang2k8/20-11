<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Tri Ân Thầy Cô — Demo</title>
<style>
  :root{
    --bg:#000;
    --white: #fff;
    --glass: rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--white)}
  .wrap{position:relative;width:100vw;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center}
  /* Loading */
  #loading{position:absolute;inset:0;z-index:30;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#0b0b0b,#050505)}
  .loader-ring{position:relative;width:140px;height:140px;border-radius:50%;display:flex;align-items:center;justify-content:center}
  /* viền nhỏ hẹp hơn (30% nhỏ hơn) */
  .loader-ring::before{content:"";position:absolute;width:150px;height:150px;border-radius:50%;
    border:4px solid transparent;border-top-color:rgba(255,255,255,0.98);border-right-color:rgba(255,255,255,0.7);
    animation:spin 1.35s linear infinite;filter:drop-shadow(0 0 8px rgba(255,255,255,0.12))}
  #icon{width:110px;height:110px;border-radius:50%;object-fit:cover;z-index:2}
  #loading p{margin-top:18px;font-size:15px;opacity:0.85}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

  /* video full-screen */
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:transparent;display:none;-webkit-user-select:none;user-select:none}

  /* transparent round button */
  .btn{position:absolute;width:86px;height:86px;border-radius:50%;border:2px solid rgba(255,255,255,0.55);background:var(--glass);display:flex;align-items:center;justify-content:center;font-size:28px;color:var(--white);backdrop-filter:blur(8px);box-shadow:0 4px 24px rgba(0,0,0,0.6);cursor:pointer;opacity:0;transform:scale(0.72);transition:opacity .45s ease,transform .45s cubic-bezier(.2,.9,.3,1);z-index:40}
  .btn.show{opacity:1;transform:scale(1)}
  #btnSwipe{bottom:14%}
  #btnCenter{top:44%}

  /* overlay big play when autoplay blocked */
  #tapToStart{position:absolute;inset:0;display:none;z-index:60;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.6))}
  #tapToStart .big{width:130px;height:130px;border-radius:50%;background:linear-gradient(135deg,#ffb6ff,#bfe9ff);display:flex;align-items:center;justify-content:center;font-size:34px;color:#111;box-shadow:0 10px 30px rgba(0,0,0,0.5);cursor:pointer}
  #tapToStart p{color:rgba(255,255,255,0.95);margin-top:18px;text-align:center;padding:0 20px}

  /* error box */
  #errorBox{position:fixed;left:12px;right:12px;top:18px;padding:12px 14px;background:#2b0000;border-radius:10px;color:#ffd7d7;z-index:80;display:none}

  /* rotate warning when landscape */
  @media (orientation:landscape){
    #loading, video, .btn, #tapToStart {display:none!important}
    body::after{content:"⚠️ Vui lòng xoay điện thoại dọc để xem";position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.6);color:white;padding:18px;border-radius:12px;z-index:999}
  }

  /* small hint when button visible */
  .hint{position:absolute;bottom:7%;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.85);font-size:13px;z-index:39;opacity:0;transition:opacity .35s}
  .hint.show{opacity:1}
</style>
</head>
<body>
  <div class="wrap">
    <div id="loading" aria-hidden="false">
      <div class="loader-ring"><img id="icon" src="icon.png" alt="icon"></div>
      <p>Đang tải — xin chờ chút...</p>
    </div>

    <video id="video" playsinline preload="auto" muted webkit-playsinline></video>

    <!-- buttons (hidden until needed) -->
    <button id="btnSwipe" class="btn" aria-hidden="true">⬇</button>
    <button id="btnCenter" class="btn" aria-hidden="true">✨</button>

    <div id="tapToStart" role="button" aria-hidden="true">
      <div class="big">▶</div>
      <p>Chạm để bắt đầu — một lần chạm sẽ mở video và âm nhạc</p>
    </div>

    <div id="errorBox"></div>
    <div class="hint" id="hint">Chạm để bật âm thanh</div>

    <!-- hidden audio -->
    <audio id="music" loop preload="auto"></audio>
  </div>

<script>
/*
  Robust single-file player behavior:
  - show loading 3.5s OR until canplaythrough (whichever later)
  - try autoplay (video muted). Start music too.
  - if autoplay blocked, show big "Tap to Start"
  - pause at checkpoints [5,10]s -> show transparent round button only at that moment
  - when button visible and no interaction, fade music down
  - clicking anywhere restores music volume
  - retry loading video/audio up to RETRY_LIMIT times if errors
*/

(() => {
  const VIDEO_SRC = 'part1.mp4';
  const MUSIC_SRC = 'nhac.mp3';
  const ICON = 'icon.png';
  const CHECKPOINTS = [5, 10]; // seconds
  const LOADING_MIN = 3500; // ms
  const RETRY_LIMIT = 3;
  const VIDEO = document.getElementById('video');
  const MUSIC = document.getElementById('music');
  const loadingEl = document.getElementById('loading');
  const btnSwipe = document.getElementById('btnSwipe');
  const btnCenter = document.getElementById('btnCenter');
  const tapToStart = document.getElementById('tapToStart');
  const errorBox = document.getElementById('errorBox');
  const hint = document.getElementById('hint');

  let retryCount = 0;
  let lastCanPlay = false;
  let checkpointsShown = new Set();
  let fadeAnim = null;

  // set sources
  VIDEO.src = VIDEO_SRC;
  MUSIC.src = MUSIC_SRC;

  // helper: show error
  function showError(msg){
    errorBox.style.display = 'block';
    errorBox.textContent = 'Lỗi tải: ' + msg + ' — Nhấn vào đây để thử lại';
    errorBox.onclick = () => { errorBox.style.display='none'; retryAll(); };
    console.error(msg);
  }

  // retry function with cache-bust
  function retryAll(){
    retryCount++;
    if (retryCount > RETRY_LIMIT) {
      showError('Không thể tải media sau nhiều lần thử. Kiểm tra kết nối hoặc thay file.');
      return;
    }
    const cb = `?cb=${Date.now()}`;
    VIDEO.src = VIDEO_SRC + cb;
    MUSIC.src = MUSIC_SRC + cb;
    // attempt reload
    VIDEO.load();
    MUSIC.load();
    attemptPlay();
  }

  // fade music volume smoothly to target (0..1) using rAF
  function fadeMusicTo(target, duration = 600){
    cancelFade();
    const start = performance.now();
    const from = MUSIC.volume || 0;
    const dv = target - from;
    function step(t){
      const p = Math.min(1, (t - start) / duration);
      MUSIC.volume = Math.max(0, Math.min(1, from + dv * p));
      if (p < 1) fadeAnim = requestAnimationFrame(step);
      else fadeAnim = null;
    }
    fadeAnim = requestAnimationFrame(step);
  }
  function cancelFade(){
    if (fadeAnim) { cancelAnimationFrame(fadeAnim); fadeAnim = null; }
  }

  // attempt autoplay: video muted first (helps mobile), try music too.
  async function attemptPlay(){
    try {
      VIDEO.muted = true; // help autoplay
      await VIDEO.play();
      // try play music (may be blocked)
      try { await MUSIC.play(); } catch(e) { console.log('music play blocked, will wait for user gesture'); hint.classList.add('show'); }
      // unmute video only after user gesture — keep muted to avoid autoplay policy on some devices
      onReadyToShow();
    } catch (err) {
      console.log('autoplay blocked for video, show tapToStart', err);
      tapToStart.style.display = 'flex';
      tapToStart.setAttribute('aria-hidden','false');
    }
  }

  // called when we decide to hide loading and show video
  function onReadyToShow(){
    // ensure minimum loading time
    setTimeout(() => {
      // hide loading with smooth opacity
      loadingEl.style.transition = 'opacity .55s ease';
      loadingEl.style.opacity = '0';
      setTimeout(() => { loadingEl.remove(); }, 600);
      VIDEO.style.display = 'block';
      // try to unmute music gradually if it already playing
      if (!MUSIC.paused) { MUSIC.volume = 0.9; }
    }, Math.max(0, LOADING_MIN - (Date.now() - startTime)));
  }

  // when canplaythrough (video buffered enough)
  VIDEO.addEventListener('canplaythrough', () => {
    lastCanPlay = true;
    // if loading min time passed, attempt play
    if (Date.now() - startTime >= LOADING_MIN) attemptPlay();
  });

  // handle video errors
  VIDEO.addEventListener('error', (e) => {
    console.error('video error', e);
    retryAll();
  });
  MUSIC.addEventListener('error', (e) => {
    console.error('music error', e);
    // music can be optional: show hint to user
    hint.classList.add('show');
  });

  // if tapToStart clicked: try to play/unmute fully
  tapToStart.addEventListener('click', async () => {
    tapToStart.style.display = 'none';
    try {
      VIDEO.muted = false;
      await VIDEO.play();
      await MUSIC.play();
      hint.classList.remove('show');
      onReadyToShow();
    } catch (e) {
      console.error('start after tap failed', e);
      showError('Không thể phát media. Thử lại.');
    }
  });

  // keep track of timeupdate and show buttons at exact times
  VIDEO.addEventListener('timeupdate', () => {
    const t = Math.floor(VIDEO.currentTime);
    // check each checkpoint only once
    CHECKPOINTS.forEach((cp, idx) => {
      if (t >= cp && !checkpointsShown.has(cp)) {
        // pause exactly at the time if not already paused
        if (!VIDEO.paused) VIDEO.pause();
        checkpointsShown.add(cp);
        // show corresponding button
        if (idx === 0) showButton(btnSwipe);
        if (idx === 1) showButton(btnCenter);
        // fade music down when button appears
        fadeMusicTo(0.28, 700);
      }
    });
  });

  function showButton(btn){
    btn.setAttribute('aria-hidden','false');
    btn.classList.add('show');
    // show small hint for sound if music muted or low
    if (MUSIC.paused || MUSIC.volume < 0.4) hint.classList.add('show');
  }

  function hideButton(btn){
    btn.classList.remove('show');
    btn.setAttribute('aria-hidden','true');
    hint.classList.remove('show');
  }

  // clicking anywhere restores music volume (and unmute video if needed)
  document.addEventListener('click', () => {
    // restore volume smoothly
    if (!MUSIC.paused) fadeMusicTo(1.0, 500);
    // if video is muted and playing, unmute (only if user interacts)
    if (VIDEO.muted) VIDEO.muted = false;
  }, {passive:true});

  // button handlers
  btnSwipe.addEventListener('click', () => {
    hideButton(btnSwipe);
    fadeMusicTo(1.0, 450);
    VIDEO.play().catch(err => console.warn('play failed after btnSwipe',err));
  });
  btnCenter.addEventListener('click', () => {
    hideButton(btnCenter);
    fadeMusicTo(1.0, 450);
    VIDEO.play().catch(err => console.warn('play failed after btnCenter',err));
  });

  // if video ends naturally, we can loop or show replay. For now do nothing.
  VIDEO.addEventListener('ended', () => {
    // optional: show replay or end screen
    console.log('video ended');
  });

  // start loading sequence
  const startTime = Date.now();
  // attempt to start loading & may be canplaythrough soon
  // call load and try autoplay after LOADING_MIN unless canplaythrough already fired
  VIDEO.load();
  MUSIC.load();
  // attempt play after LOADING_MIN (this handles cases where canplaythrough didn't fire)
  setTimeout(() => {
    // if canplaythrough hasn't fired, still attempt to play (some browsers stream enough)
    if (!lastCanPlay) {
      attemptPlay();
    }
  }, LOADING_MIN + 50);

  // in case autoplay succeeds early, call attemptPlay now (but it's safe)
  attemptPlay();

  // safety: if both media error or blocked and user doesn't interact, show tapToStart after a few seconds
  setTimeout(() => {
    if (VIDEO.paused && tapToStart.style.display === 'none') {
      tapToStart.style.display = 'flex';
      tapToStart.setAttribute('aria-hidden','false');
    }
  }, 4500);

})();
</script>
</body>
</html>
