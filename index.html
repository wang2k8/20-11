<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>3D Viewer - Full Màn Hình Tự Động</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body, html { height:100%; overflow:hidden; background:#000; font-family:sans-serif; touch-action: none; }
    
    /* WRAPPER TỰ ĐỘNG XOAY (mobile only) */
    #container-wrapper {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 100vw; height: 100vh;
      perspective: 1200px;
    }

    /* MOBILE: xoay nội dung 3D khi dọc */
    @media (orientation: portrait) and (max-width: 768px) {
      #container-wrapper {
        width: 100vh; height: 100vw;
        transform: translate(-50%, -50%) rotate(90deg);
      }
    }

    #container {
      width: 100%; height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.1s ease-out;
      position: relative;
    }

    /* [ẢNH TO 250%] */
    .layer {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%) translateZ(0) scale(1);
      width: 225vw; max-width: 1050px;
      border-radius: 24px;
      box-shadow: 0 0 60px rgba(0,0,0,0.9);
      opacity: 0; transition: opacity 0.6s;
    }
    .layer img {
      width: 100%; height: auto; display: block;
      border-radius: 24px;
      image-rendering: -webkit-optimize-contrast;
    }
    .layer.visible { opacity: 1; }

    /* NÚT BẮT ĐẦU (mobile) */
    #start-btn {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #00aaff; color: white; border: none; border-radius: 50px;
      padding: 18px 36px; font-size: 1.2em; font-weight: bold; z-index: 9999;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5); cursor: pointer;
      animation: pulse 2s infinite; display: none;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    @media (max-width: 768px) { #start-btn { display: block; } }
    #start-btn.active { display: none; }

    #hint {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.6); color: #fff; padding: 8px 16px; border-radius: 20px;
      font-size: 14px; opacity: 0; transition: .3s; pointer-events: none; z-index: 100;
    }
    #hint.show { opacity: 1; }
  </style>
</head>
<body>

  <button id="start-btn">BẮT ĐẦU 3D</button>
  <div id="hint">Kéo 2 ngón / Cuộn chuột để zoom</div>

  <div id="container-wrapper">
    <div id="container"></div>
  </div>

  <script>
    const container = document.getElementById('container');
    const wrapper = document.getElementById('container-wrapper');
    const startBtn = document.getElementById('start-btn');
    const hint = document.getElementById('hint');
    const layers = [];
    const totalLayers = 5;

    // === [TÙY CHỈNH TỪNG LAYER] ===
    const layerSettings = [
      { z: -250, scale: 1.3, opacity: 1.0 },
      { z: -150, scale: 1.2, opacity: 1.0 },
      { z:    0, scale: 1.0, opacity: 1.0 },
      { z:  150, scale: 0.9, opacity: 0.95 },
      { z:  250, scale: 0.8, opacity: 0.9 }
    ];

    const MAX_TILT = 24.5;
    let currentZoom = 1;
    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 3.0;
    let is3DEnabled = false;
    let lastBeta = 0, lastGamma = 0;

    // === FULL MÀN HÌNH TỰ ĐỘNG ===
    function goFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    }

    // === TỰ ĐỘNG FULL MÀN HÌNH KHI MỞ TRANG ===
    const isDesktop = !/Mobi|Android|iPhone/i.test(navigator.userAgent);
    if (isDesktop) {
      // PC: mở full ngay
      setTimeout(goFullscreen, 500);
    } else {
      // Mobile: xoay ngang + full khi nhấn nút
      startBtn.addEventListener('click', () => {
        startBtn.classList.add('active');
        is3DEnabled = true;
        goFullscreen(); // Full màn hình sau khi nhấn

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') startSensor();
          });
        } else {
          startSensor();
        }

        hint.classList.add('show');
        setTimeout(() => hint.classList.remove('show'), 4000);
      });
    }

    // Tạo layer
    for (let i = 0; i < totalLayers; i++) {
      const div = document.createElement('div');
      div.className = 'layer';
      const img = new Image();
      img.src = `img${i+1}.png`;
      img.draggable = false;
      div.appendChild(img);
      container.appendChild(div);

      const s = layerSettings[i];
      div.style.transform = `translate(-50%,-50%) translateZ(${s.z}px) scale(${s.scale})`;
      div.style.opacity = 0;
      layers.push({ el: div, ...s });
    }

    setTimeout(() => {
      layers.forEach((l, i) => {
        setTimeout(() => {
          l.el.classList.add('visible');
          l.el.style.opacity = l.opacity;
        }, i * 150);
      });
    }, 300);

    // === ÁP DỤNG XOAY + ZOOM ===
    function applyTransform(rotX = 0, rotY = 0, zoom = currentZoom) {
      if (!is3DEnabled) return;
      container.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg) scale(${zoom})`;
    }

    // === CẢM BIẾN (mobile) ===
    function startSensor() {
      window.addEventListener('deviceorientation', e => {
        if (!is3DEnabled) return;
        const gamma = e.gamma || lastGamma;
        const beta = e.beta || lastBeta;
        lastGamma = gamma; lastBeta = beta;

        const tiltX = Math.max(-MAX_TILT, Math.min(MAX_TILT, gamma));
        const tiltY = Math.max(-MAX_TILT, Math.min(MAX_TILT, beta - 45));
        applyTransform(-tiltY, tiltX, currentZoom);
      });
    }

    // === ZOOM (mobile) ===
    let startDist = 0;
    container.addEventListener('touchstart', e => {
      if (!is3DEnabled || e.touches.length !== 2) return;
      e.preventDefault();
      startDist = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
    }, { passive: false });

    container.addEventListener('touchmove', e => {
      if (!is3DEnabled || e.touches.length !== 2) return;
      e.preventDefault();
      const currentDist = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
      const delta = currentDist / startDist;
      currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom * delta));
      startDist = currentDist;
      applyTransform(-lastBeta + 45, lastGamma, currentZoom);
    }, { passive: false });

    // === DESKTOP: CHUỘT + WHEEL ===
    if (isDesktop) {
      is3DEnabled = true;
      let mouseX = 0, mouseY = 0;

      document.addEventListener('mousemove', e => {
        const rect = wrapper.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        mouseX = ((e.clientX - cx) / cx) * MAX_TILT;
        mouseY = ((e.clientY - cy) / cy) * MAX_TILT;
        applyTransform(mouseY, mouseX, currentZoom);
      });

      document.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom * delta));
        applyTransform(mouseY, mouseX, currentZoom);
      }, { passive: false });

      document.addEventListener('mouseleave', () => applyTransform(0, 0, currentZoom));

      setTimeout(() => hint.classList.add('show'), 1000);
      setTimeout(() => hint.classList.remove('show'), 5000);
    }

    // === TỰ ĐỘNG XOAY NỘI DUNG 3D (mobile only) ===
    function updateOrientation() {
      if (isDesktop) return;
      const isLandscape = window.innerHeight < window.innerWidth;
      if (isLandscape) {
        wrapper.style.width = '100vw';
        wrapper.style.height = '100vh';
        wrapper.style.transform = 'translate(-50%, -50%) rotate(0deg)';
      } else {
        wrapper.style.width = '100vh';
        wrapper.style.height = '100vw';
        wrapper.style.transform = 'translate(-50%, -50%) rotate(90deg)';
      }
    }
    window.addEventListener('orientationchange', updateOrientation);
    window.addEventListener('resize', updateOrientation);
    updateOrientation();
  </script>
</body>
</html>
