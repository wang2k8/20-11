<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>3D Parallax - Layer Gần Như Chồng</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body, html { height:100%; overflow:hidden; background:#000; font-family:sans-serif; touch-action: none; }
    
    #container-wrapper {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 100vw; height: 100vh;
      perspective: 1200px;
      will-change: transform;
    }

    @media (orientation: portrait) and (max-width: 768px) {
      #container-wrapper {
        width: 100vh; height: 100vw;
        transform: translate(-50%, -50%) rotate(90deg);
      }
    }

    #container {
      width: 100%; height: 100%;
      transform-style: preserve-3d;
      position: relative;
      will-change: transform;
    }

    .layer {
      position: absolute;
      top: 50%; left: 50%;
      width: 90vw; max-width: 900px;
      transform: translate(-50%, -50%) translateZ(0) scale(1);
      opacity: 0;
      will-change: transform, opacity;
      backface-visibility: hidden;
      transition: opacity 0.5s;
    }
    .layer img {
      width: 100%; height: auto; display: block;
      image-rendering: crisp-edges;
      -webkit-user-drag: none;
      border-radius: 0 !important;
    }
    .layer.visible { opacity: 1; }

    #start-btn {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #00aaff; color: white; border: none; border-radius: 50px;
      padding: 18px 36px; font-size: 1.2em; font-weight: bold; z-index: 9999;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5); cursor: pointer;
      animation: pulse 2s infinite; display: none;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    @media (max-width: 768px) { #start-btn { display: block; } }
    #start-btn.active { display: none; }

    #hint {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.6); color: #fff; padding: 8px 16px; border-radius: 20px;
      font-size: 14px; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 100;
    }
    #hint.show { opacity: 1; }
  </style>
</head>
<body>

  <button id="start-btn">BẮT ĐẦU 3D</button>
  <div id="hint">Cuộn / Kéo để xem hiệu ứng</div>

  <div id="container-wrapper">
    <div id="container"></div>
  </div>

  <script>
    const container = document.getElementById('container');
    const wrapper = document.getElementById('container-wrapper');
    const startBtn = document.getElementById('start-btn');
    const hint = document.getElementById('hint');
    const layers = [];
    const totalLayers = 5;

    const layerSettings = [
      { z: 0, scale: 1.8, opacity: 1.0, parallax: 0.2 },
      { z:  200, scale: 1.5, opacity: 1.0, parallax: 0.4 },
      { z:  335, scale: 1.3, opacity: 1.0, parallax: 0.6 },
      { z:   470, scale: 1.1, opacity: 0.95, parallax: 0.8 },
      { z:   535, scale: 1.0, opacity: 1.0, parallax: 1.0 }
    ];

    // GIẢM 3 LẦN NỮA → TỔNG CỘNG GIẢM 4 LẦN (24.5 / 16 = 1.53125)
    const MAX_TILT = 1.53125;  // ← ĐÃ GIẢM CỰC MẠNH

    let currentZoom = 1;
    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 3.0;
    let is3DEnabled = false;
    let lastBeta = 0, lastGamma = 0;
    let scrollY = 0;

    // === RENDER ===
    let rafId = null;
    function render(rotX, rotY, zoom, parallaxOffset = 0) {
      if (!is3DEnabled) return;
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => {
        container.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg) scale(${zoom})`;
        
        layers.forEach((layer, i) => {
          const s = layerSettings[i];
          const offset = parallaxOffset * s.parallax;
          layer.el.style.transform = 
            `translate(-50%, -50%) ` +
            `translateZ(${s.z}px) ` +
            `translateY(${offset}px) ` +
            `scale(${s.scale})`;
        });
      });
    }

    // Tạo layer
    for (let i = 0; i < totalLayers; i++) {
      const div = document.createElement('div');
      div.className = 'layer';
      const img = new Image();
      img.src = `img${i+1}.png`;
      img.draggable = false;
      div.appendChild(img);
      container.appendChild(div);

      const s = layerSettings[i];
      div.style.opacity = 0;
      layers.push({ el: div, ...s });

      img.onload = () => {
        setTimeout(() => render(0, 0, currentZoom, scrollY), 100);
      };
    }

    setTimeout(() => {
      layers.forEach((l, i) => {
        setTimeout(() => {
          l.el.classList.add('visible');
          l.el.style.opacity = l.opacity;
        }, i * 40);
      });
    }, 150);

    // === FULL MÀN HÌNH ===
    function goFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    }

    const isDesktop = !/Mobi|Android|iPhone/i.test(navigator.userAgent);

    if (isDesktop) {
      setTimeout(goFullscreen, 300);
      is3DEnabled = true;
    } else {
      startBtn.addEventListener('click', () => {
        startBtn.classList.add('active');
        is3DEnabled = true;
        goFullscreen();

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(res => {
            if (res === 'granted') startSensor();
          });
        } else {
          startSensor();
        }

        hint.classList.add('show');
        setTimeout(() => hint.classList.remove('show'), 3000);
      });
    }

    // === CẢM BIẾN (mobile) ===
    let sensorTimeout = null;
    function startSensor() {
      window.addEventListener('deviceorientation', e => {
        if (!is3DEnabled) return;
        const gamma = e.gamma || lastGamma;
        const beta = e.beta || lastBeta;
        lastGamma = gamma; lastBeta = beta;

        clearTimeout(sensorTimeout);
        sensorTimeout = setTimeout(() => {
          const tiltX = Math.max(-MAX_TILT, Math.min(MAX_TILT, gamma));
          const tiltY = Math.max(-MAX_TILT, Math.min(MAX_TILT, beta - 45));
          render(-tiltY, tiltX, currentZoom, scrollY);
        }, 16);
      });
    }

    // === PARALLAX SCROLL ===
    let lastTouchY = 0;
    let isTouching = false;

    document.addEventListener('wheel', e => {
      e.preventDefault();
      scrollY += e.deltaY * 0.1;
      scrollY = Math.max(-30, Math.min(30, scrollY));
      render(-lastBeta + 45, lastGamma, currentZoom, scrollY);
    }, { passive: false });

    container.addEventListener('touchstart', e => {
      if (!is3DEnabled) return;
      lastTouchY = e.touches[0].clientY;
      isTouching = true;
    }, { passive: false });

    container.addEventListener('touchmove', e => {
      if (!is3DEnabled || !isTouching) return;
      e.preventDefault();
      const currentY = e.touches[0].clientY;
      const deltaY = (lastTouchY - currentY) * 0.8;
      scrollY += deltaY;
      scrollY = Math.max(-30, Math.min(30, scrollY));
      lastTouchY = currentY;
      render(-lastBeta + 45, lastGamma, currentZoom, scrollY);
    }, { passive: false });

    container.addEventListener('touchend', () => {
      isTouching = false;
    });

    // === ZOOM (mobile) ===
    let startDist = 0;
    container.addEventListener('touchstart', e => {
      if (!is3DEnabled || e.touches.length !== 2) return;
      e.preventDefault();
      startDist = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
    }, { passive: false });

    container.addEventListener('touchmove', e => {
      if (!is3DEnabled || e.touches.length !== 2) return;
      e.preventDefault();
      const currentDist = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
      const delta = currentDist / startDist;
      currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom * delta));
      startDist = currentDist;
      render(-lastBeta + 45, lastGamma, currentZoom, scrollY);
    }, { passive: false });

    // === DESKTOP: CHUỘT ===
    if (isDesktop) {
      let mouseX = 0, mouseY = 0;
      let mouseRaf = null;

      document.addEventListener('mousemove', e => {
        const rect = wrapper.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        mouseX = ((e.clientX - cx) / cx) * MAX_TILT;
        mouseY = ((e.clientY - cy) / cy) * MAX_TILT;

        cancelAnimationFrame(mouseRaf);
        mouseRaf = requestAnimationFrame(() => {
          render(mouseY, mouseX, currentZoom, scrollY);
        });
      });

      document.addEventListener('mouseleave', () => render(0, 0, currentZoom, scrollY));

      setTimeout(() => hint.classList.add('show'), 800);
      setTimeout(() => hint.classList.remove('show'), 4000);
    }

    // === TỰ ĐỘNG XOAY (mobile) ===
    function updateOrientation() {
      if (isDesktop) return;
      const isLandscape = window.innerHeight < window.innerWidth;
      wrapper.style.width = isLandscape ? '100vw' : '100vh';
      wrapper.style.height = isLandscape ? '100vh' : '100vw';
      wrapper.style.transform = `translate(-50%, -50%) rotate(${isLandscape ? 0 : 90}deg)`;
    }
    window.addEventListener('orientationchange', updateOrientation);
    window.addEventListener('resize', updateOrientation);
    updateOrientation();
  </script>
</body>
</html>
