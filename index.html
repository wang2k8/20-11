<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Parallax - Tốc độ ánh sáng</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            overflow:hidden;
            background:#fff;
            touch-action:pan-y;
            -webkit-text-size-adjust:none;
        }
        .scene{
            position:fixed;
            inset:0;
            perspective:1200px;
        }
        .container{
            position:absolute;
            top:50%;left:50%;
            transform:translate(-50%,-50%);
            width:100vmin;
            height:100vmin;
            max-width:100vw;
            max-height:100vh;
        }
        .container::before{
            content:"";
            position:absolute;
            inset:0;
            background:rgba(255,255,255,0.97);
            pointer-events:none;
            z-index:0;
        }
        img{
            position:absolute;
            top:50%;left:50%;
            transform:translate(-50%,-50%);
            max-width:100%;
            max-height:100%;
            object-fit:contain;
            pointer-events:none;
            user-select:none;
            -webkit-user-drag:none;
            opacity:0;
            transition:opacity .5s ease-out;
        }
        img.loaded{opacity:1}
        #img1{z-index:5}#img2{z-index:4}#img3{z-index:3}#img4{z-index:2}#img5{z-index:1}

        #start{
            position:fixed;
            inset:0;
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:#fff;
            font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
            font-size:22px;
            font-weight:600;
            border:none;
            z-index:9999;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:24px;
            transition:opacity .6s;
        }
        #start.hide{display:none}
        .pulse{
            animation:pulse 2s infinite;
        }
        @keyframes pulse{
            0%,100%{transform:scale(1)}
            50%{transform:scale(1.1)}
        }

        @media(orientation:portrait) and (max-width:768px){
            img{transform:translate(-50%,-50%) rotate(90deg)}
        }
    </style>

    <!-- Tăng tốc kết nối -->
    <link rel="preconnect" href="https://yourdomain.com">
    <link rel="dns-prefetch" href="https://yourdomain.com">
</head>
<body>
    <div class="scene">
        <div class="container">
            <!-- WebP trong suốt + fallback PNG -->
            <img id="img5" src="img1.webp" onerror="this.src='img1.png'" alt="1">
            <img id="img4" src="img2.webp" onerror="this.src='img2.png'" alt="2">
            <img id="img3" src="img3.webp" onerror="this.src='img3.png'" alt="3">
            <img id="img2" src="img4.webp" onerror="this.src='img4.png'" alt="4">
            <img id="img1" src="img5.webp" onerror="this.src='img5.png'" alt="5">
        </div>
    </div>

    <button id="start">
        <div style="font-size:52px" class="pulse">Touch để bật 3D</div>
        <div style="font-size:17px;opacity:0.9">Nghiêng máy • Xem ngay lập tức</div>
    </button>

    <script>
        const layers = [
            {el:document.getElementById('img1'),f:0.10},
            {el:document.getElementById('img2'),f:0.30},
            {el:document.getElementById('img3'),f:0.60},
            {el:document.getElementById('img4'),f:0.80},
            {el:document.getElementById('img5'),f:1.00}
        ];
        const maxMove = 100;
        const defaultX = 15;
        const defaultY = -10;

        const btn = document.getElementById('start');
        let ok = false;

        // Góc mặc định đẹp ngay từ đầu
        move(defaultX, defaultY);

        // Preload + decode siêu nhanh
        ['img1.webp','img2.webp','img3.webp','img4.webp','img5.webp'].forEach(src=>{
            const img = new Image();
            img.src = src;
            img.decoding = 'async';
            img.onload = () => {
                const target = document.querySelector(`[src="${src}"]`);
                if(target) target.classList.add('loaded');
            };
        });

        btn.onclick = () => {
            if(typeof DeviceOrientationEvent?.requestPermission === 'function'){
                DeviceOrientationEvent.requestPermission().then(r=>{
                    if(r==='granted'){
                        ok=true;
                        btn.classList.add('hide');
                        run();
                    }
                }).catch(()=>{});
            }else{
                ok=true;
                btn.classList.add('hide');
                run();
            }
        };

        function run(){
            window.addEventListener('deviceorientation', e=>{
                if(!ok) return;
                const x = e.gamma || 0;
                const y = e.beta  || 0;
                move(x*1, y*1);
            });

            // PC chuột
            document.addEventListener('mousemove', e=>{
                const mx = (e.clientX/innerWidth - 0.5)*50;
                const my = (e.clientY/innerHeight - 0.5)*50;
                move(mx, my);
            });
        }

        function move(dx, dy){
            requestAnimationFrame(()=>{
                layers.forEach(l=>{
                    const ex = Math.tanh(dx * l.f / maxMove) * maxMove;
                    const ey = Math.tanh(dy * l.f / maxMove) * maxMove;
                    const rot = dx * 0.05;
                    l.el.style.transform = 
                        `translate(-50%,-50%) translate(${ex}px,${ey}px) rotate(${rot}deg)`;
                });
            });
        }

        // Tự chạy nếu không phải iOS
        if(!/iPad|iPhone|iPod/.test(navigator.userAgent)){
            ok=true;
            btn.classList.add('hide');
            run();
        }
    </script>
</body>
</html>
